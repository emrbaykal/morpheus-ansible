# Role 16: ubuntu-minio-conf

## Overview

Installs the MinIO server binary from a DEB package, creates a dedicated system user, generates the MinIO environment configuration using a Jinja2 template, configures the systemd service unit, and verifies that the MinIO API and console ports are listening. This role transforms a prepared disk environment (from role 15) into a running MinIO object storage service.

---

## Purpose

MinIO is an S3-compatible object storage server designed for high-performance, cloud-native workloads. This role installs MinIO and configures it to:

- Run as a dedicated, unprivileged system user for security
- Serve data from the XFS-formatted disks mounted by role 15
- Listen on configurable S3 API and web console ports
- Start automatically on system boot via systemd

The configuration is generated dynamically from a Jinja2 template using credentials and port numbers supplied at runtime through Morpheus.

---

## What It Does

The role performs the following tasks in order:

1. **Creates the `minio` system user**: Creates a system account with no login shell (`/sbin/nologin`) and no home directory. This user owns the MinIO process for privilege separation.

2. **Creates `/etc/minio/` directory**: Creates the directory that will hold the MinIO environment configuration file, and sets ownership to the `minio` user.

3. **Installs the MinIO DEB package**: Installs the MinIO server binary via a DEB package file. This package installs:
   - `/usr/local/bin/minio` — The MinIO server binary
   - `/usr/lib/systemd/system/minio.service` — The systemd service unit

4. **Counts available data disks**: Counts the number of mounted MinIO drives (directories matching `/opt/minio/miniodrive*`) to dynamically generate the `MINIO_VOLUMES` configuration variable.

5. **Generates the MinIO environment file**: Applies the `templates/minio.j2` Jinja2 template to create `/etc/minio/minio.env`. This file contains:
   ```bash
   MINIO_ROOT_USER=<minio_root_user>
   MINIO_ROOT_PASSWORD=<minio_root_password>
   MINIO_VOLUMES="/opt/minio/miniodrive0 /opt/minio/miniodrive1 ..."
   MINIO_OPTS="--address :<minio_s3_api_port> --console-address :<minio_console_port>"
   ```

6. **Updates the systemd service unit**: Modifies `/usr/lib/systemd/system/minio.service` to set:
   - `WorkingDirectory=/opt/minio` — The working directory for the MinIO process
   - `User=minio` — Run as the minio system user
   - `Group=minio` — Run in the minio group
   - `EnvironmentFile=/etc/minio/minio.env` — Point to the generated env file

7. **Triggers the minio-service handler**: Reloads the systemd daemon (`systemctl daemon-reload`) and enables and starts the MinIO service.

8. **Verifies ports are listening**: Checks that the S3 API port and console port are open and accepting connections using `ss` or `netstat`, confirming MinIO started successfully.

---

## Role Directory Structure

```
roles/16-ubuntu-minio-conf/
├── README.md               # This file
├── defaults/
│   └── main.yml            # Default variable values
├── handlers/
│   └── main.yml            # Handler: minio-service
├── meta/
│   └── main.yml            # Role metadata and dependencies
├── tasks/
│   └── main.yml            # Task definitions
└── templates/
    └── minio.j2            # Jinja2 template for MinIO environment configuration
```

---

## Key Files

### `templates/minio.j2`

The Jinja2 template that generates `/etc/minio/minio.env`:

```jinja2
# MinIO Environment Configuration
# Generated by Ansible - Do not edit manually

MINIO_ROOT_USER={{ minio_root_user }}
MINIO_ROOT_PASSWORD={{ minio_root_password }}
MINIO_VOLUMES="{% for i in range(disk_count) %}/opt/minio/miniodrive{{ i }}{% if not loop.last %} {% endif %}{% endfor %}"
MINIO_OPTS="--address :{{ minio_s3_api_port }} --console-address :{{ minio_console_port }}"
```

---

## Variables

| Variable | Required | Source | Example | Description |
|----------|----------|--------|---------|-------------|
| `minio_root_user` | Yes | Morpheus custom option | `minioadmin` | MinIO root user (S3 access key equivalent). |
| `minio_root_password` | Yes | Morpheus custom option | `MinioPass123!` | MinIO root password (S3 secret key equivalent). Must be at least 8 characters. |
| `minio_s3_api_port` | Yes | Morpheus custom option | `9000` | Port for the MinIO S3 API endpoint. |
| `minio_console_port` | Yes | Morpheus custom option | `9001` | Port for the MinIO web console (browser UI). |

### Morpheus Integration

```
morpheus['customOptions']['minio_root_user']      →  minio_root_user variable
morpheus['customOptions']['minio_root_password']  →  minio_root_password variable
morpheus['customOptions']['minio_s3_api_port']    →  minio_s3_api_port variable
morpheus['customOptions']['minio_console_port']   →  minio_console_port variable
```

---

## Handlers

| Handler Name      | Trigger Condition                           | Action                                                                |
|-------------------|---------------------------------------------|-----------------------------------------------------------------------|
| `minio-service`   | When env file or service unit changes       | `systemctl daemon-reload && systemctl enable minio && systemctl start minio` |

---

## Dependencies

- **Role 15** (`ubuntu-minio-post-provision`) must have completed and all MinIO data disks must be mounted at `/opt/minio/miniodrive*`.
- Requires `root` or `sudo` privileges (`become: true`).
- The MinIO DEB package file must be accessible (either included in the role or downloaded during the task).

---

## Playbook Usage

This role is executed by the following playbook:

**`ubuntu-minio-object-storage.yml`** — Runs on all MinIO nodes (step 2 of 3).

Example playbook snippet:

```yaml
- hosts: minio_nodes
  become: true
  roles:
    - role: 15-ubuntu-minio-post-provision
    - role: 16-ubuntu-minio-conf
    - role: 17-ubuntu-minio-clinet-conf
```

---

## Verification Commands

After the role runs, verify the MinIO server installation:

```bash
# Verify MinIO binary is installed and get its version
minio --version

# Verify the minio system user was created
id minio
getent passwd minio

# Verify the MinIO service is running
systemctl status minio

# Verify MinIO is listening on the configured ports
ss -tlnp | grep minio
# Expected: Ports 9000 and 9001 (or configured values) should be listed

# Verify the environment file was created
cat /etc/minio/minio.env

# Verify the MinIO API is responding
curl -s http://localhost:9000/minio/health/live
# Expected: HTTP 200 OK (empty body)

# Access the web console
# Open http://<node-ip>:9001 in a browser and log in with the configured credentials

# Check MinIO logs via systemd journal
journalctl -u minio -n 50 --no-pager
```

---

## Notes and Caveats

- **Minimum password length**: `MINIO_ROOT_PASSWORD` must be at least 8 characters. MinIO will refuse to start if this requirement is not met.
- **MINIO_VOLUMES format**: For a distributed MinIO deployment (multiple nodes), the `MINIO_VOLUMES` variable should use an expansion pattern like `http://minio-node-{1...4}/opt/minio/miniodrive{0...3}`. This single-node configuration uses local paths. Extend the template for distributed deployments.
- **Port conflicts**: Ensure that no other services are listening on the configured S3 API and console ports before deploying. Common conflicts include other web servers (port 9000) or Portainer (port 9001).
- **TLS**: This role configures MinIO without TLS. For production deployments, configure TLS by providing certificates in `/etc/minio/certs/` and updating `MINIO_OPTS` with `--certs-dir /etc/minio/certs`. MinIO supports both manual certificate placement and integration with cert-manager.
- **Data ownership**: The MinIO data directories (`/opt/minio/miniodrive*`) should be owned by the `minio` user. If the disks were formatted and mounted as root (role 15), ensure `chown -R minio:minio /opt/minio` is run or added as a task.

